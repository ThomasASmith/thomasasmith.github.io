<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Use Case 01: Algorithmic specification of clusters • CRTspat</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Use Case 01: Algorithmic specification of clusters">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">CRTspat</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.3.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Usecase1.html">Use Case 01: Algorithmic specification of clusters</a></li>
    <li><a class="dropdown-item" href="../articles/Usecase2.html">Use Case 02: Simulation of trials with geographical spillover</a></li>
    <li><a class="dropdown-item" href="../articles/Usecase3.html">Use Case 03: Estimation of intracluster correlations (ICC) by cluster size</a></li>
    <li><a class="dropdown-item" href="../articles/Usecase4.html">Use Case 04: Estimation of optimal cluster size for a trial with pre-determined buffer width</a></li>
    <li><a class="dropdown-item" href="../articles/Usecase5.html">Use Case 05: Analysis of trials (including methods for analysing spillover)</a></li>
    <li><a class="dropdown-item" href="../articles/Usecase6.html">Use Case 06: Thematic mapping of the geography of a CRT</a></li>
    <li><a class="dropdown-item" href="../articles/Usecase7.html">Use Case 07: Power and sample size calculations allowing for spillover</a></li>
    <li><a class="dropdown-item" href="../articles/Usecase8.html">Use Case 08: Eggs - to fry or scramble?</a></li>
    <li><a class="dropdown-item" href="../articles/Usecase9.html">Use Case 09: Preparation of datasets for `CRTspat`</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Use Case 01: Algorithmic specification of clusters</h1>
            
      

      <div class="d-none name"><code>Usecase1.Rmd</code></div>
    </div>

    
    
<p>The way in which clusters are assigned in cluster randomized trials
(CRTs) can profoundly affect the efficiency of the trial. Allocating
clusters by algorithm makes it easy to generate alternative cluster
allocations for any given trial site, both for real-world trials and for
exploring this neglected aspect of trial design in simulations. The
<code>CRTspat</code> package contains R functions developed for this
purpose.</p>
<p>Input to the package is in the form of a data frame with one record
for each geo-location in a trial area. Most of the functions of the
package return a list of class <code>CRTsp</code>, which consists of the
input data frame augmented with additional vectors (e.g. coding
clusters, arms, or buffer zones), and lists containing descriptors of
the dataset. Objects of class <code>CRTsp</code> can also be used as
input to most of the functions.</p>
<p>After each step, <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> can be used to provide a
description of the output <code>CRTsp</code> object and
<code><a href="../reference/plotCRT.html">plotCRT()</a></code> can be used to output a descriptive plot, or a
map of the locations, clusters, arms, buffer zones or other
geographically structured analysis results.</p>
<ul>
<li><p>In general the package functions do not expect to find repeated
values for outcomes for the same location. The
<code><a href="../reference/aggregateCRT.html">aggregateCRT()</a></code> function is used to aggregate data with the
same co-ordinates so that this condition is satisfied. In particular, if
the input database contains outcome data (e.g. if it contains baseline
survey results), these should be provided in the form of a numerator
<code>base_num</code> and denominator <code>base_denom</code> for each
record. These values will be summed by <code><a href="../reference/aggregateCRT.html">aggregateCRT()</a></code> over
all records with the same co-ordinates. An object of class
<code>CRTsp</code> is output.</p></li>
<li>
<p>The <code><a href="../reference/specify_clusters.html">specify_clusters()</a></code> function carries out
algorithmic assignment of clusters and outputs a <code>CRTsp</code>
object augmented with the cluster assignments. One of three different
algorithms must be selected:</p>
<ul>
<li>
<code>algorithm = "NN"</code> implements a nearest neighbour
algorithm. Iteratively One household is selected and a cluster of size k
is constructed by adding its k-1 nearest neighbors (NN). These points
are removing these points from the data set, and this step is repeated
iteratively until all the points have been allocated. <a href="http://jmonlong.github.io/Hippocamplus/2018/06/09/cluster-same-size/#methods" class="external-link">This
algorithm</a> will often lead to connected clusters, in a “fish scale”
manner. This is the default option.</li>
<li>
<code>algorithm = "TSP"</code> implements the
<code>repetitive_nn</code> option of the <a href="https://CRAN.R-project.org/package=TSP" class="external-link"><code>TSP</code>
package</a> for solving the travelling salesman problem. This finds an
efficient path through the study locations. Clusters are formed by
grouping the required number of locations sequentially along the path.
Note that this is not guaranteed to give rise to congruent
clusters.</li>
<li>
<code>algorithm = "kmeans"</code> implements a <a href="https://en.wikipedia.org/wiki/K-means_clustering" class="external-link">k-means
algorithm</a> that aims to partition the locations into the required
number of clusters in which each observation belongs to the cluster with
the nearest cluster centroid. k-means clustering minimizes
within-cluster variances (squared Euclidean distances) but does not
necessarily give equal-sized clusters. Irrespective of the algorithm,
the target number of points allocated to each cluster is specified by
the parameter <code>h</code>.</li>
</ul>
</li>
<li><p>The <code><a href="../reference/randomizeCRT.html">randomizeCRT()</a></code> function carries out a simple
randomization of clusters to arms, and outputs a <code>CRTsp</code>
object augmented with the assignments. (If baseline data are available
matched pair randomization is available as an option)</p></li>
</ul>
<p>The units to be randomized will usually be households, but the
algorithms can be used to generate clusters with equal geographical
areas by randomizing pixels. In this case a dataset containing x,y
coordinates for each pixel should be used as input.</p>
<p>The example uses locations and baseline test positivity data from a
site in Kenya. The input dataset contains a single record for each test
so there are multiple records of test positivity for many locations.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">CRTspat</span><span class="op">)</span></span>
<span><span class="va">example_locations</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/readdata.html">readdata</a></span><span class="op">(</span><span class="st">'example_site.csv'</span><span class="op">)</span></span>
<span><span class="co"># assign the denominator to the baseline data</span></span>
<span><span class="va">example_locations</span><span class="op">$</span><span class="va">base_denom</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="co"># convert to a `CRTsp` object</span></span>
<span><span class="va">exampleCRT</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CRTsp.html">CRTsp</a></span><span class="op">(</span><span class="va">example_locations</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">exampleCRT</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## ===============================CLUSTER RANDOMISED TRIAL ===========================</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Summary of coordinates</span></span>
<span><span class="co">## ----------------------</span></span>
<span><span class="co">##         Min.   : 1st Qu.: Median : Mean   : 3rd Qu.: Max.   :</span></span>
<span><span class="co">##       x -3.20    -1.31    -0.24     0.00     1.35     5.16   </span></span>
<span><span class="co">##       y -5.08    -2.84    -0.17     0.00     2.49     6.16   </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Total area (within  0.2 km of a location) :  27.6 sq.km</span></span>
<span><span class="co">## Total area (convex hull) :  48.2 sq.km</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Locations and Clusters</span></span>
<span><span class="co">## ----------------------                                          -                        </span></span>
<span><span class="co">## Coordinate system                      (x, y)                        </span></span>
<span><span class="co">## Not aggregated. Total records: 3172. Unique locations:          1181                        </span></span>
<span><span class="co">## Available clusters (across both arms)                           Not assigned                        </span></span>
<span><span class="co">## No randomization          -                        </span></span>
<span><span class="co">## No power calculations to report          -                        </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Other variables in dataset</span></span>
<span><span class="co">## --------------------------          RDT_test_result  base_denom</span></span></code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Aggregate data for multiple observations for the same location Only the (x,y) co-ordinates and numerical</span></span>
<span><span class="co"># auxiliary variables</span></span>
<span><span class="va">example</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aggregateCRT.html">aggregateCRT</a></span><span class="op">(</span><span class="va">exampleCRT</span>, auxiliaries <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"RDT_test_result"</span>, <span class="st">"base_denom"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">example</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## ===============================CLUSTER RANDOMISED TRIAL ===========================</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Summary of coordinates</span></span>
<span><span class="co">## ----------------------</span></span>
<span><span class="co">##         Min.   : 1st Qu.: Median : Mean   : 3rd Qu.: Max.   :</span></span>
<span><span class="co">##       x -3.20    -1.40    -0.30    -0.07     1.26     5.16   </span></span>
<span><span class="co">##       y -5.08    -2.84     0.19     0.05     2.49     6.16   </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Total area (within  0.2 km of a location) :  27.6 sq.km</span></span>
<span><span class="co">## Total area (convex hull) :  48.2 sq.km</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Locations and Clusters</span></span>
<span><span class="co">## ----------------------                                          -                        </span></span>
<span><span class="co">## Coordinate system                      (x, y)                        </span></span>
<span><span class="co">## Locations:                                                      1181                        </span></span>
<span><span class="co">## Available clusters (across both arms)                           Not assigned                        </span></span>
<span><span class="co">## No randomization          -                        </span></span>
<span><span class="co">## No power calculations to report          -                        </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Other variables in dataset</span></span>
<span><span class="co">## --------------------------          RDT_test_result  base_denom</span></span></code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot map of locations</span></span>
<span><span class="fu"><a href="../reference/plotCRT.html">plotCRT</a></span><span class="op">(</span><span class="va">example</span>, map <span class="op">=</span> <span class="cn">TRUE</span>, showLocations <span class="op">=</span> <span class="cn">TRUE</span>, maskbuffer <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></code></pre></div>
<p>
<img src="example1a.r-1.png" alt=""><br><em>Fig 1.1 Map of
locations</em>
</p>
<p>In the example shown here a target cluster size of 50 locations is
set, but the heterogeneity in spatial density of the locations leads to
considerable variation in the number of locations assigned to each
cluster.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">example_clustered</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/specify_clusters.html">specify_clusters</a></span><span class="op">(</span>trial <span class="op">=</span> <span class="va">example</span>, h <span class="op">=</span> <span class="fl">50</span>, algorithm <span class="op">=</span> <span class="st">'NN'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">example_clustered</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## ===============================CLUSTER RANDOMISED TRIAL ===========================</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Summary of coordinates</span></span>
<span><span class="co">## ----------------------</span></span>
<span><span class="co">##         Min.   : 1st Qu.: Median : Mean   : 3rd Qu.: Max.   :</span></span>
<span><span class="co">##       x -3.20    -1.40    -0.30    -0.07     1.26     5.16   </span></span>
<span><span class="co">##       y -5.08    -2.84     0.19     0.05     2.49     6.16   </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Total area (within  0.2 km of a location) :  27.6 sq.km</span></span>
<span><span class="co">## Total area (convex hull) :  48.2 sq.km</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Locations and Clusters</span></span>
<span><span class="co">## ----------------------                                          -                        </span></span>
<span><span class="co">## Coordinate system                      (x, y)                        </span></span>
<span><span class="co">## Locations:                                                      1181                        </span></span>
<span><span class="co">## Available clusters (across both arms)                           24                        </span></span>
<span><span class="co">##   Per cluster mean number of points                             49.2                        </span></span>
<span><span class="co">##   Per cluster s.d. number of points                             3.9                        </span></span>
<span><span class="co">## No randomization          -                        </span></span>
<span><span class="co">## No power calculations to report          -                        </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Other variables in dataset</span></span>
<span><span class="co">## --------------------------          RDT_test_result  base_denom</span></span></code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plotCRT.html">plotCRT</a></span><span class="op">(</span><span class="va">example_clustered</span>, map <span class="op">=</span> <span class="cn">TRUE</span>, showClusterLabels <span class="op">=</span> <span class="cn">TRUE</span>, maskbuffer <span class="op">=</span> <span class="fl">0.2</span>, labelsize <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>
<img src="example1b.r-1.png" alt=""><br><em>Fig 1.2 Map of
clusters</em>
</p>
<p>A smoothed map of the baseline prevalence surface is produced using a
geostatistical model in <a href="https://www.r-inla.org/" class="external-link">R-INLA</a>.
Details of the implementation in <code>CRTspat</code> are in the <a href="../reference/CRTanalysis.html">documentation of
<code>CRTanalysis</code></a> and of <a href="Usecase5.html">Use Case
5</a>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://Matrix.R-forge.R-project.org" class="external-link">Matrix</a></span><span class="op">)</span></span>
<span><span class="va">examplemesh100</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/readdata.html">readdata</a></span><span class="op">(</span><span class="st">"examplemesh100.rds"</span><span class="op">)</span></span>
<span><span class="va">baselineanalysis</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CRTanalysis.html">CRTanalysis</a></span><span class="op">(</span>trial<span class="op">=</span><span class="va">example_clustered</span>,</span>
<span>                     method <span class="op">=</span> <span class="st">'INLA'</span>, link<span class="op">=</span><span class="st">'logit'</span>, baselineOnly <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                     baselineNumerator <span class="op">=</span> <span class="st">"RDT_test_result"</span>,</span>
<span>                     baselineDenominator <span class="op">=</span>  <span class="st">"base_denom"</span>,</span>
<span>                     clusterEffects <span class="op">=</span> <span class="cn">FALSE</span>, spatialEffects <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                     requireMesh <span class="op">=</span> <span class="cn">TRUE</span>, inla_mesh <span class="op">=</span> <span class="va">examplemesh100</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Analysis of baseline only, using INLA</span></span></code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plotCRT.html">plotCRT</a></span><span class="op">(</span><span class="va">baselineanalysis</span>, map <span class="op">=</span> <span class="cn">TRUE</span>, fill <span class="op">=</span> <span class="st">'prediction'</span><span class="op">)</span></span></code></pre></div>
<p>
<img src="example1c.r-1.png" alt=""><br><em>Fig 1.3 Smoothed surface
of baseline prevalence</em>
</p>
<p>A summary of the baseline prevalence at cluster level is used in this
example to match clusters on baseline prevalence and then generate a
randomisation based on matched pairs.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">example_randomized</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/randomizeCRT.html">randomizeCRT</a></span><span class="op">(</span><span class="va">example_clustered</span>, matchedPair <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  baselineNumerator <span class="op">=</span> <span class="st">"RDT_test_result"</span>, baselineDenominator <span class="op">=</span> <span class="st">"base_denom"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## *** computed distance to nearest measurements in discordant arm ***</span></span></code></pre>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">example_randomized</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## ===============================CLUSTER RANDOMISED TRIAL ===========================</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Summary of coordinates</span></span>
<span><span class="co">## ----------------------</span></span>
<span><span class="co">##                Min.   : 1st Qu.: Median : Mean   : 3rd Qu.: Max.   :</span></span>
<span><span class="co">##       x        -3.20    -1.40    -0.30    -0.07     1.26     5.16   </span></span>
<span><span class="co">##       y        -5.08    -2.84     0.19     0.05     2.49     6.16   </span></span>
<span><span class="co">## nearestDiscord -1.64    -0.39     0.01     0.03     0.40     2.57   </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Total area (within  0.2 km of a location) :  27.6 sq.km</span></span>
<span><span class="co">## Total area (convex hull) :  48.2 sq.km</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Locations and Clusters</span></span>
<span><span class="co">## ----------------------                                          -                        </span></span>
<span><span class="co">## Coordinate system                      (x, y)                        </span></span>
<span><span class="co">## Locations:                                                      1181                        </span></span>
<span><span class="co">## Available clusters (across both arms)                           24                        </span></span>
<span><span class="co">##   Per cluster mean number of points                             49.2                        </span></span>
<span><span class="co">##   Per cluster s.d. number of points                             3.9                        </span></span>
<span><span class="co">## Cluster randomization:                      Matched pairs randomized                        </span></span>
<span><span class="co">## No power calculations to report          -                        </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Other variables in dataset</span></span>
<span><span class="co">## --------------------------          RDT_test_result  base_denom  base_num  pair</span></span></code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plotCRT.html">plotCRT</a></span><span class="op">(</span><span class="va">example_randomized</span>, map <span class="op">=</span> <span class="cn">TRUE</span>, maskbuffer<span class="op">=</span><span class="fl">0.2</span>, legend.position<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.8</span>,<span class="fl">0.8</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>
<img src="example1d.r-1.png" alt=""><br><em>Fig 1.4 Map of arm
assignments</em>
</p>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Thomas Smith.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
