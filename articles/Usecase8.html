<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="CRTspat">
<title>Use Case 8: Eggs - to fry or scramble? • CRTspat</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Use Case 8: Eggs - to fry or scramble?">
<meta property="og:description" content="CRTspat">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">CRTspat</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/CRTspat.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Usecase1.html">Use Case 1: Algorithmic specification of clusters</a>
    <a class="dropdown-item" href="../articles/Usecase2.html">Use Case 2: Simulation of trials with geographical contamination</a>
    <a class="dropdown-item" href="../articles/Usecase3.html">Use Case 3: Estimation of intracluster correlations (ICC) by cluster size</a>
    <a class="dropdown-item" href="../articles/Usecase4.html">Use Case 4: Estimation of optimal cluster size for a trial with pre-determined buffer width</a>
    <a class="dropdown-item" href="../articles/Usecase5.html">Use Case 5: Analysis of trials (including methods for analysing contamination)</a>
    <a class="dropdown-item" href="../articles/Usecase6.html">Use Case 6: Thematic mapping of the geography of a CRT</a>
    <a class="dropdown-item" href="../articles/Usecase7.html">Use Case 7: Power and sample size calculations allowing for contamination</a>
    <a class="dropdown-item" href="../articles/Usecase8.html">Use Case 8: Eggs - to fry or scramble?</a>
    <a class="dropdown-item" href="../articles/Usecase9.html">Use Case 9: Preparation of datasets for `CRTspat`</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Use Case 8: Eggs - to fry or scramble?</h1>
            
      
      
      <div class="d-none name"><code>Usecase8.Rmd</code></div>
    </div>

    
    
<!--To build the vignette
# since the vignette takes a long time to run, it is not run with every build
# as suggested here https://ropensci.org/blog/2019/12/08/precompute-vignettes/
# to Knit this vignette without this time consuming step being part of the default build
knitr::knit("vignettes/Usecase7.Rmd.orig", output = "vignettes/Usecase7.Rmd")
rmarkdown.html_vignette.check_title = FALSE
devtools::install(build_vignettes = TRUE)
-->
<p>In trials of malaria interventions, a ‘fried-egg’ design is often
used to avoid the downward bias in the estimates of efficacy caused by
contamination. This entails estimating the outcome only from the cores
of the clusters. However, the intervention must also be introduced in
the buffer zone, so the trial may be very expensive if there are high
per capita intervention costs. Since the buffer zone is excluded from
data collection, there are usually no data on whether the buffer is
large enough to avoid contamination effects. A precautionary approach
with large buffer zones is therefore the norm. However with ‘fried-eggs’
there are no data on the scale of the contamination, so if the effect
was swamped by unexpectedly large contamination, this would be
indistinguishable from failure of the intervention.</p>
<p>The alternative design is to sample in the buffer zones, accepting
some degree of contamination. The data analysis might then be used to
estimate the scale of contamination (see <a href="Usecase5.html">Use
Case 5</a>). The statistical model might be to adjust the estimate of
effect size for the contamination effect, or to decide which
contaminated areas to exclude <em>post hoc</em> from the definitive
analysis (based on pre-defined criteria). This is expected to lead to
some loss of power, compared to collecting the same amount of outcome
data from the core area alone (though this might be compensated for by
increasing data collection), but is likely to be less complicated to
organise, allowing the trial to be carried out over a much smaller area,
with far fewer locations needing to be randomized (see <a href="Usecase4.html">Use Case 4</a>).</p>
<p>In this example, the effects of reducing the numbers of observations
on power and bias are evaluated in simulated datasets. To compare
‘fried-egg’ strategies with comparable designs that sample the whole
area, sets of locations are removed, either randomly from the whole
area, or systematically depending on the distance from the boundary
between arms. As in <a href="Usecase7.html">Use Case 7</a>, spatially
homogeneous background disease rates are assigned, using
<code>propensity &lt;- 1</code>, fixed values are used for the outcome
in the control arm, the target ICC of the simulations and the number of
clusters in each arm of the trial. Efficacy is also fixed at 0.4. The
contamination interval is sampled from a uniform(0, 1.5km)
distribution.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">CRTspat</span><span class="op">)</span></span>
<span><span class="co"># use the locations only from example dataset (as with Use Case 7)</span></span>
<span><span class="va">example</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/readdata.html">readdata</a></span><span class="op">(</span><span class="st">"exampleCRT.txt"</span><span class="op">)</span></span>
<span><span class="va">trial</span> <span class="op">&lt;-</span> <span class="va">example</span><span class="op">$</span><span class="va">trial</span><span class="op">[</span> , <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span>, <span class="st">"denom"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">trial</span><span class="op">$</span><span class="va">propensity</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">CRT</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CRTsp.html">CRTsp</a></span><span class="op">(</span><span class="va">trial</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co"># specify:</span></span>
<span><span class="co">#   prevalence in the absence of intervention;</span></span>
<span><span class="co">#   anticipated ICC;</span></span>
<span><span class="co">#   clusters in each arm</span></span>
<span><span class="va">outcome0</span> <span class="op">&lt;-</span> <span class="fl">0.4</span></span>
<span><span class="va">ICC</span> <span class="op">&lt;-</span> <span class="fl">0.05</span></span>
<span><span class="va">k</span> <span class="op">&lt;-</span> <span class="fl">25</span></span>
<span><span class="co"># the number of trial simulations required (a small number, is used for testing, the plots are based on 1000)</span></span>
<span><span class="va">nsimulations</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="va">theta_vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">nsimulations</span>,<span class="fl">0</span>,<span class="fl">1.5</span><span class="op">)</span></span>
<span><span class="va">radii</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.4</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">proportions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.4</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">scenarios</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>radius <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">radii</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">6</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                proportion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">6</span><span class="op">)</span>, <span class="va">proportions</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">7</span><span class="op">)</span></span></code></pre></div>
<p>Two user functions are required:</p>
<ul>
<li>randomization and trial simulation</li>
<li>analysis of each simulated trial with different sets of locations
removed</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">analyseReducedCRT</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">CRT</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">trial</span> <span class="op">&lt;-</span> <span class="va">CRT</span><span class="op">$</span><span class="va">trial</span></span>
<span>  <span class="va">radius</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[[</span><span class="st">"radius"</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">proportion</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[[</span><span class="st">"proportion"</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">radius</span>,<span class="va">proportion</span><span class="op">)</span></span>
<span>  <span class="va">nlocations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">trial</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">radius</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">trial</span><span class="op">$</span><span class="va">num</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">nearestDiscord</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">radius</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">proportion</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># add random variation to proportion to avoid heaping</span></span>
<span>    <span class="va">proportion</span> <span class="op">&lt;-</span> <span class="va">proportion</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">0.05</span>, <span class="fl">0.05</span><span class="op">)</span></span>
<span>    <span class="va">trial</span><span class="op">$</span><span class="va">num</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">nlocations</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">proportion</span>, <span class="cn">NA</span>, <span class="va">trial</span><span class="op">$</span><span class="va">num</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">trial</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">num</span><span class="op">)</span>,<span class="op">]</span></span>
<span>  <span class="va">resX</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CRTanalysis.html">CRTanalysis</a></span><span class="op">(</span><span class="va">trial</span>,method <span class="op">=</span> <span class="st">"LME4"</span>, cfunc <span class="op">=</span> <span class="st">"X"</span><span class="op">)</span></span>
<span>  <span class="va">resZ</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CRTanalysis.html">CRTanalysis</a></span><span class="op">(</span><span class="va">trial</span>,method <span class="op">=</span> <span class="st">"LME4"</span>, cfunc <span class="op">=</span> <span class="st">"Z"</span><span class="op">)</span></span>
<span>  <span class="va">LRchisq</span> <span class="op">&lt;-</span> <span class="va">resZ</span><span class="op">$</span><span class="va">pt_ests</span><span class="op">$</span><span class="va">deviance</span> <span class="op">-</span> <span class="va">resX</span><span class="op">$</span><span class="va">pt_ests</span><span class="op">$</span><span class="va">deviance</span></span>
<span>  <span class="va">significant</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">LRchisq</span> <span class="op">&gt;</span> <span class="fl">3.84</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>radius <span class="op">=</span> <span class="va">radius</span>,</span>
<span>                 proportion <span class="op">=</span> <span class="va">proportion</span>,</span>
<span>                 observations <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">trial</span><span class="op">)</span>,</span>
<span>                 significant <span class="op">=</span> <span class="va">significant</span>,</span>
<span>                 effect_size <span class="op">=</span> <span class="va">resX</span><span class="op">$</span><span class="va">pt_ests</span><span class="op">$</span><span class="va">effect_size</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># randomization and trial simulation</span></span>
<span><span class="va">randomize_simulate</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">theta</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">ex</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/specify_clusters.html">specify_clusters</a></span><span class="op">(</span><span class="va">CRT</span>, k <span class="op">=</span> <span class="va">k</span>, algo <span class="op">=</span> <span class="st">"kmeans"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/randomizeCRT.html">randomizeCRT</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/simulateCRT.html">simulateCRT</a></span><span class="op">(</span>effect <span class="op">=</span> <span class="fl">0.4</span>, generateBaseline <span class="op">=</span> <span class="cn">FALSE</span>, outcome0 <span class="op">=</span> <span class="va">outcome0</span>,</span>
<span>                ICC_inp <span class="op">=</span> <span class="va">ICC</span>, theta_inp <span class="op">=</span> <span class="va">theta</span>,</span>
<span>                matchedPair <span class="op">=</span> <span class="cn">FALSE</span>, scale <span class="op">=</span> <span class="st">"proportion"</span>, denominator <span class="op">=</span> <span class="st">"denom"</span>, tol <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span>  <span class="co"># The results are collected in a data frame</span></span>
<span>  <span class="va">sub_results_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">scenarios</span>, MARGIN <span class="op">=</span> <span class="fl">1</span>,  FUN <span class="op">=</span> <span class="va">analyseReducedCRT</span>, CRT <span class="op">=</span> <span class="va">ex</span><span class="op">)</span></span>
<span>  <span class="va">sub_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">sub_results_matrix</span>, <span class="va">as.data.frame</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">sub_results</span><span class="op">$</span><span class="va">theta_inp</span> <span class="op">&lt;-</span> <span class="va">theta</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">sub_results</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Collect all the analysis results and plot. Note that some analyses
result in warnings (because of problems computing some of the
descriptive statistics when the number of observations in some clusters
is very small)</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>simulation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>,</span>
<span>                radius <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>,</span>
<span>               proportion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>,</span>
<span>               observations <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>,</span>
<span>               significant <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>,</span>
<span>               effect_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>,</span>
<span>               gamma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">simulation</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">theta</span> <span class="kw">in</span> <span class="va">theta_vec</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">simulation</span> <span class="op">&lt;-</span> <span class="va">simulation</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>  <span class="va">sub_results</span> <span class="op">&lt;-</span> <span class="fu">randomize_simulate</span><span class="op">(</span><span class="va">theta</span><span class="op">)</span></span>
<span>  <span class="va">sub_results</span><span class="op">$</span><span class="va">simulation</span> <span class="op">&lt;-</span> <span class="va">simulation</span></span>
<span>  <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">results</span>,<span class="va">sub_results</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## =====================    SIMULATION OF CLUSTER RANDOMISED TRIAL    =================</span></span>
<span><span class="co">## Estimating the smoothing required to achieve the target ICC of 0.05 </span></span>
<span><span class="co">## </span></span>
<span>                                                         </span>
<span><span class="co">## 0 00.1 00.2 00.3 00.4 00.5 00 00 0.10 0.20 0.30 0.40 0.5</span></span>
<span><span class="co">## =====================    SIMULATION OF CLUSTER RANDOMISED TRIAL    =================</span></span>
<span><span class="co">## Estimating the smoothing required to achieve the target ICC of 0.05 </span></span>
<span><span class="co">## </span></span>
<span>                                                         </span>
<span><span class="co">## 0 00.1 00.2 00.3 00.4 00.5 00 00 0.10 0.20 0.30 0.40 0.5</span></span></code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results</span><span class="op">$</span><span class="va">fried</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">results</span><span class="op">$</span><span class="va">radius</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="st">'fried'</span>,<span class="st">'scrambled'</span><span class="op">)</span></span>
<span><span class="va">results</span><span class="op">$</span><span class="va">bias</span> <span class="op">&lt;-</span> <span class="va">results</span><span class="op">$</span><span class="va">effect_size</span> <span class="op">-</span> <span class="fl">0.5</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fig8_1a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">results</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">observations</span>, y <span class="op">=</span> <span class="va">significant</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">fried</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">2</span>, se <span class="op">=</span> <span class="cn">FALSE</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#b2df8a"</span>,<span class="st">"#D55E00"</span>,<span class="st">"#0072A7"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">'Number of locations in analysis'</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">'Power'</span><span class="op">)</span></span>
<span><span class="va">fig8_1b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">results</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">theta_inp</span>, y <span class="op">=</span> <span class="va">significant</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">fried</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">2</span>, se <span class="op">=</span> <span class="cn">FALSE</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#b2df8a"</span>,<span class="st">"#D55E00"</span>,<span class="st">"#0072A7"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">'Simulated contamination range (km)'</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">'Power'</span><span class="op">)</span></span>
<span><span class="va">fig8_1c</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">results</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">observations</span>, y <span class="op">=</span> <span class="va">bias</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">fried</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">2</span>, se <span class="op">=</span> <span class="cn">FALSE</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#b2df8a"</span>,<span class="st">"#D55E00"</span>,<span class="st">"#0072A7"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">'Number of locations in analysis'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">'Bias'</span><span class="op">)</span></span>
<span><span class="va">fig8_1d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">results</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">theta_inp</span>, y <span class="op">=</span> <span class="va">bias</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">fried</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">2</span>, se <span class="op">=</span> <span class="cn">FALSE</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#b2df8a"</span>,<span class="st">"#D55E00"</span>,<span class="st">"#0072A7"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">'Simulated contamination range (km)'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">'Bias'</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/cowplot/" class="external-link">cowplot</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">fig8_1a</span>, <span class="va">fig8_1b</span>, <span class="va">fig8_1c</span>, <span class="va">fig8_1d</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'a'</span>, <span class="st">'b'</span>, <span class="st">'c'</span>, <span class="st">'d'</span><span class="op">)</span>, label_size <span class="op">=</span> <span class="fl">14</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="analysis">Analysis<a class="anchor" aria-label="anchor" href="#analysis"></a>
</h4>
<p>Figure 8.1. is are based on analysing 1000 simulated datasets (12,000
scenarios in all). The power is calculated as the proportion of
significance tests with likelihood ratio p &lt; 0.05.</p>
<p>The fried-egg design suffers little loss of power with exclusion of
observations until the sample size is less than about 750 (the
suggestion that there is a maximum at a sample size of about 900
locations is presumably an effect of the smoothing of the results).
while the ‘scrambled’ egg trials lose power with each reduction in the
number of observations (Figure 8.1a). Substantive loss of power is
associated with contamination range of 1 km or more in this dataset.
With</p>
<p>There is less absolute bias with the fried-egg designs but the effect
is small except when the number of locations is very small (Figure
8.1c), or the simulated contamination range very large (Figure
8.1d).</p>
<p>
<img src="example8c.r-1.png"><br><em>Fig 8.1 Power and bias by number
of locations in analysis <span class="math inline">\(\color{purple}{\textbf{----}}\)</span> : Randomly
sampled locations removed; <span class="math inline">\(\color{green}{\textbf{----}}\)</span> : Fried-egg-
locations in boundary zone removed; <span class="math inline">\(\color{blue}{\textbf{----}}\)</span> : Analyses
with no locations removed. </em>
</p>
</div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Thomas Smith.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
